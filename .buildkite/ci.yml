# Build and test Bun on macOS, Linux, and Windows.
# https://buildkite.com/docs/pipelines/defining-steps
#
# If a step has the `robobun: true` label, robobun will listen
# to webhooks from Buildkite and provision a VM to run the step.
#
# Changes to this file will be automatically uploaded on the next run
# for a particular commit.
#
# Future tests machines to be added:
# - macOS 12
# - Windows Server 2016 & 2019
# - Amazon Linux 2 & 2023
# - CentOS / RHEL / Fedora / other Linux distros
# - Docker containers
# - Rasberry Pi?
steps:
  # Windows x64
  - key: "windows-x64"
    group: ":windows: x64"
    steps:
      - key: "windows-x64-build-deps"
        label: ":windows: x64 - build-deps"
        agents:
          queue: "build-windows"
          os: "windows"
          arch: "x64"
        artifact_paths:
          - "build\\bun-deps\\*.lib"
        env:
          CCACHE_DISABLE: "1"
        command:
          - ".\\scripts\\all-dependencies.ps1"

      - key: "windows-x64-build-zig"
        label: ":windows: x64 - build-zig"
        agents:
          queue: "build-darwin"
          os: "darwin" # cross-compile on Linux or Darwin
          arch: "aarch64"
        command:
          - "./.buildkite/scripts/build-zig.sh windows x64"

      - key: "windows-x64-build-cpp"
        label: ":windows: x64 - build-cpp"
        agents:
          queue: "build-windows"
          os: "windows"
          arch: "x64"
        artifact_paths:
          # HACK: See scripts/build-bun-cpp.ps1
          # - "build\\bun-cpp-objects.a"
          - "build\\bun-cpp-objects.a.*"
        env:
          CCACHE_DISABLE: "1"
        command:
          - ".\\scripts\\build-bun-cpp.ps1"

      - key: "windows-x64-build-bun"
        label: ":windows: x64 - build-bun"
        depends_on:
          - "windows-x64-build-deps"
          - "windows-x64-build-zig"
          - "windows-x64-build-cpp"
        agents:
          queue: "build-windows"
          os: "windows"
          arch: "x64"
        artifact_paths:
          - "bun-windows-x64.zip"
          - "bun-windows-x64-profile.zip"
          - "features.json"
        env:
          CCACHE_DISABLE: "1"
        command:
          - ".\\scripts\\buildkite-link-bun.ps1"

      - key: "windows-x64-test-bun"
        label: ":windows: x64 - test-bun"
        if: "build.branch != 'main'"
        parallelism: 10
        soft_fail:
          - exit_status: 1
        retry:
          automatic:
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "windows-x64-build-bun"
        agents:
          robobun: "true"
          os: "windows"
          arch: "x64"
        command:
          - "node .\\scripts\\runner.node.mjs --step windows-x64-build-bun"

  # Windows x64-baseline
  - key: "windows-x64-baseline"
    group: ":windows: x64-baseline"
    steps:
      - key: "windows-x64-baseline-build-deps"
        label: ":windows: x64-baseline - build-deps"
        agents:
          queue: "build-windows"
          os: "windows"
          arch: "x64"
        artifact_paths:
          - "build\\bun-deps\\*.lib"
        env:
          CCACHE_DISABLE: "1"
          USE_BASELINE_BUILD: "1"
        command:
          - ".\\scripts\\all-dependencies.ps1"

      - key: "windows-x64-baseline-build-zig"
        label: ":windows: x64-baseline - build-zig"
        agents:
          queue: "build-darwin"
          os: "darwin" # cross-compile on Linux or Darwin
          arch: "aarch64"
        command:
          - "./.buildkite/scripts/build-zig.sh windows x64"

      - key: "windows-x64-baseline-build-cpp"
        label: ":windows: x64-baseline - build-cpp"
        agents:
          queue: "build-windows"
          os: "windows"
          arch: "x64"
        artifact_paths:
          # HACK: See scripts/build-bun-cpp.ps1
          # - "build\\bun-cpp-objects.a"
          - "build\\bun-cpp-objects.a.*"
        env:
          CCACHE_DISABLE: "1"
          USE_BASELINE_BUILD: "1"
        command:
          - ".\\scripts\\build-bun-cpp.ps1"

      - key: "windows-x64-baseline-build-bun"
        label: ":windows: x64-baseline - build-bun"
        depends_on:
          - "windows-x64-baseline-build-deps"
          - "windows-x64-baseline-build-zig"
          - "windows-x64-baseline-build-cpp"
        agents:
          queue: "build-windows"
          os: "windows"
          arch: "x64"
        artifact_paths:
          - "bun-windows-x64-baseline.zip"
          - "bun-windows-x64-baseline-profile.zip"
          - "features.json"
        env:
          CCACHE_DISABLE: "1"
          USE_BASELINE_BUILD: "1"
        command:
          - ".\\scripts\\buildkite-link-bun.ps1 -Baseline $$True"

      - key: "windows-x64-baseline-test-bun"
        label: ":windows: x64-baseline - test-bun"
        if: "build.branch != 'main'"
        parallelism: 10
        soft_fail:
          - exit_status: 1
        retry:
          automatic:
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "windows-x64-baseline-build-bun"
        agents:
          robobun: "true"
          os: "windows"
          arch: "x64"
        command:
          - "node .\\scripts\\runner.node.mjs --step windows-x64-baseline-build-bun"
